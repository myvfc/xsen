<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CheerPal ‚Äî Controlador de Transmisi√≥n</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<style>
  :root {
    --pink: #FF2D78; --pink-glow: #ff2d7844; --pink-dim: #c4185a;
    --navy: #0a0e1a; --panel: #111827; --panel2: #1a2236;
    --border: #1f2d47; --text: #e8eaf6; --muted: #6b7a99;
    --green: #00e676; --amber: #ffab00; --blue: #2979ff; --purple: #d500f9;
    --radius: 12px;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', sans-serif; background: var(--navy); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }

  /* ‚îÄ‚îÄ PIN SCREEN ‚îÄ‚îÄ */
  #pin-screen {
    position: fixed; inset: 0; background: var(--navy);
    display: flex; align-items: center; justify-content: center; z-index: 999;
    background-image: radial-gradient(ellipse at 30% 20%, #ff2d7818 0%, transparent 60%),
                      radial-gradient(ellipse at 70% 80%, #2979ff12 0%, transparent 60%);
  }
  .pin-box {
    text-align: center; background: var(--panel); border: 1px solid var(--border);
    border-radius: 20px; padding: 48px 56px;
    box-shadow: 0 0 60px #ff2d7820; max-width: 380px; width: 100%;
  }
  .pin-logo { font-family: 'Bebas Neue', sans-serif; font-size: 2.2rem; letter-spacing: 3px; color: var(--pink); text-shadow: 0 0 30px var(--pink-glow); margin-bottom: 4px; }
  .pin-logo span { color: var(--text); }
  .pin-gym-name { font-size: 0.78rem; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px; min-height: 18px; }
  .pin-tagline { color: var(--muted); font-size: 0.82rem; margin-bottom: 28px; }
  .pin-label { font-size: 0.78rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
  #pin-input {
    width: 100%; background: var(--navy); border: 2px solid var(--border);
    border-radius: 10px; color: var(--text); font-size: 2rem;
    letter-spacing: 12px; text-align: center; padding: 14px; outline: none;
    transition: border-color .2s; font-family: 'Bebas Neue', sans-serif;
  }
  #pin-input:focus { border-color: var(--pink); box-shadow: 0 0 0 3px var(--pink-glow); }
  #pin-btn {
    margin-top: 20px; width: 100%; background: var(--pink); border: none;
    border-radius: 10px; color: #fff; font-family: 'Bebas Neue', sans-serif;
    font-size: 1.4rem; letter-spacing: 2px; padding: 14px; cursor: pointer;
    transition: background .2s, box-shadow .2s;
  }
  #pin-btn:hover { background: var(--pink-dim); box-shadow: 0 0 20px var(--pink-glow); }
  #pin-error { color: var(--pink); font-size: 0.82rem; margin-top: 12px; height: 20px; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 24px; background: var(--panel);
    border-bottom: 1px solid var(--border);
    position: sticky; top: 0; z-index: 50;
  }
  .logo { font-family: 'Bebas Neue', sans-serif; font-size: 1.9rem; letter-spacing: 3px; color: var(--pink); text-shadow: 0 0 20px var(--pink-glow); }
  .logo span { color: var(--text); }
  .header-gym { font-size: 0.75rem; color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-top: -4px; }
  .header-status { display: flex; align-items: center; gap: 20px; }
  .live-badge {
    display: flex; align-items: center; gap: 8px;
    background: #ff2d7822; border: 1px solid var(--pink);
    border-radius: 20px; padding: 5px 14px;
    font-family: 'Bebas Neue', sans-serif; font-size: 1rem; letter-spacing: 2px; color: var(--pink);
  }
  .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--pink); animation: pulse 1.2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.4;transform:scale(1.3)} }
  .listener-count { color: var(--muted); font-size: 0.85rem; }
  .listener-count strong { color: var(--text); }

  /* ‚îÄ‚îÄ TEAM BAR ‚îÄ‚îÄ */
  .team-bar {
    display: flex; align-items: center; gap: 10px; flex-wrap: wrap;
    padding: 12px 24px; background: var(--panel2); border-bottom: 1px solid var(--border);
  }
  .team-bar-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); margin-right: 6px; }
  .team-btn {
    background: var(--navy); border: 2px solid var(--border); border-radius: 8px;
    color: var(--muted); font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem;
    letter-spacing: 2px; padding: 8px 22px; cursor: pointer; transition: all .2s;
  }
  .team-btn:hover { border-color: var(--pink); color: var(--pink); }
  .team-btn.active { border-color: var(--pink); color: #fff; background: var(--pink); box-shadow: 0 0 14px var(--pink-glow); }
  .team-btn.all-btn.active { background: var(--panel2); border-color: var(--green); color: var(--green); box-shadow: 0 0 14px #00e67644; }

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  .main { display: grid; grid-template-columns: 1fr 1fr; gap: 0; flex: 1; min-height: 0; }
  .panel {
    padding: 20px; border-right: 1px solid var(--border);
    display: flex; flex-direction: column; gap: 16px;
    overflow-y: auto; max-height: calc(100vh - 160px);
  }
  .panel:last-child { border-right: none; }
  .panel-title {
    font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; letter-spacing: 2px; color: var(--muted);
    border-bottom: 1px solid var(--border); padding-bottom: 10px;
    display: flex; align-items: center; gap: 10px;
  }
  .panel-title .badge { background: var(--pink); color: #fff; border-radius: 20px; padding: 2px 10px; font-size: 0.8rem; letter-spacing: 1px; }

  /* ‚îÄ‚îÄ FAN MESSAGES ‚îÄ‚îÄ */
  #fan-feed { display: flex; flex-direction: column; gap: 10px; }
  .fan-msg-card {
    background: var(--navy); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 14px 16px; display: flex; flex-direction: column; gap: 8px;
    animation: slideIn .3s ease; transition: border-color .2s;
  }
  .fan-msg-card:hover { border-color: var(--pink-dim); }
  @keyframes slideIn { from{opacity:0;transform:translateY(-8px)} to{opacity:1;transform:translateY(0)} }
  .fan-msg-meta { display: flex; align-items: center; justify-content: space-between; }
  .fan-msg-name { font-weight: 700; font-size: 0.9rem; color: var(--pink); }
  .fan-msg-team { font-size: 0.72rem; color: var(--muted); background: var(--panel2); padding: 2px 8px; border-radius: 20px; }
  .fan-msg-time { font-size: 0.72rem; color: var(--muted); }
  .fan-msg-text { font-size: 0.9rem; line-height: 1.5; }
  .fan-msg-actions { display: flex; gap: 8px; }
  .shoutout-btn {
    background: transparent; border: 1px solid var(--pink); color: var(--pink);
    border-radius: 6px; font-size: 0.8rem; font-family: 'Bebas Neue', sans-serif;
    letter-spacing: 1px; padding: 5px 14px; cursor: pointer; transition: all .2s;
  }
  .shoutout-btn:hover { background: var(--pink); color: #fff; box-shadow: 0 0 10px var(--pink-glow); }
  .shoutout-btn.done { background: #00e67622; border-color: var(--green); color: var(--green); cursor: default; }
  .dismiss-btn {
    background: transparent; border: 1px solid var(--border); color: var(--muted);
    border-radius: 6px; font-size: 0.8rem; padding: 5px 10px; cursor: pointer; transition: all .2s;
  }
  .dismiss-btn:hover { border-color: #ff4444; color: #ff4444; }
  .empty-feed { text-align: center; color: var(--muted); font-size: 0.85rem; padding: 40px 20px; border: 1px dashed var(--border); border-radius: var(--radius); }

  /* ‚îÄ‚îÄ BROADCAST CONTROLS ‚îÄ‚îÄ */
  .type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .type-btn {
    background: var(--navy); border: 2px solid var(--border); border-radius: 10px;
    padding: 12px 10px; cursor: pointer; transition: all .2s; text-align: center;
    display: flex; flex-direction: column; gap: 4px;
  }
  .type-btn .type-icon { font-size: 1.4rem; }
  .type-btn .type-label { font-family: 'Bebas Neue', sans-serif; font-size: 0.95rem; letter-spacing: 1px; color: var(--muted); }
  .type-btn.active { border-color: var(--pink); background: var(--pink-glow); }
  .type-btn.active .type-label { color: var(--pink); }
  .type-btn[data-type="Hype"].active { border-color: var(--amber); background: #ffab0022; }
  .type-btn[data-type="Hype"].active .type-label { color: var(--amber); }
  .type-btn[data-type="Rotaci√≥n"].active { border-color: var(--blue); background: #2979ff22; }
  .type-btn[data-type="Rotaci√≥n"].active .type-label { color: var(--blue); }
  .type-btn[data-type="Encuesta"].active { border-color: var(--purple); background: #d500f922; }
  .type-btn[data-type="Encuesta"].active .type-label { color: var(--purple); }

  .field-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); margin-bottom: 6px; }
  textarea.broadcast-input {
    width: 100%; background: var(--navy); border: 2px solid var(--border);
    border-radius: 10px; color: var(--text); font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem; padding: 12px 14px; outline: none; resize: vertical;
    transition: border-color .2s; min-height: 80px;
  }
  textarea.broadcast-input:focus { border-color: var(--pink); }

  .ticker-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
  .ticker-toggle {
    display: flex; align-items: center; gap: 8px;
    background: var(--navy); border: 2px solid var(--border);
    border-radius: 8px; padding: 8px 14px; cursor: pointer;
    font-size: 0.82rem; color: var(--muted); transition: all .2s; white-space: nowrap;
  }
  .ticker-toggle.on { border-color: var(--amber); color: var(--amber); background: #ffab0015; }
  .ticker-toggle.sound-on { border-color: var(--green); color: var(--green); background: #00e67615; }
  .ticker-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }

  .quick-grid { display: flex; flex-wrap: wrap; gap: 6px; }
  .quick-btn {
    background: var(--navy); border: 1px solid var(--border); border-radius: 6px;
    padding: 6px 12px; font-size: 0.78rem; color: var(--muted); cursor: pointer; transition: all .2s;
  }
  .quick-btn:hover { border-color: var(--pink); color: var(--pink); }

  #fire-btn {
    width: 100%; padding: 18px; background: var(--pink); border: none; border-radius: 12px;
    font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; letter-spacing: 3px;
    color: #fff; cursor: pointer; transition: all .2s;
    box-shadow: 0 4px 20px var(--pink-glow); position: relative; overflow: hidden;
  }
  #fire-btn:hover { background: var(--pink-dim); box-shadow: 0 4px 30px #ff2d7866; transform: translateY(-1px); }
  #fire-btn:active { transform: translateY(1px); }
  #fire-btn:disabled { background: var(--panel2); box-shadow: none; transform: none; }
  #fire-btn::after { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, #ffffff22 0%, transparent 60%); }
  #end-session-btn {
    background: transparent; border: 1.5px solid #ff444466; border-radius: 8px;
    color: #ff6666; font-family: 'Bebas Neue', sans-serif; font-size: 0.9rem;
    letter-spacing: 1px; padding: 6px 14px; cursor: pointer; transition: all .2s;
  }
  #end-session-btn:hover { background: #ff444422; border-color: #ff4444; color: #ff4444; }
  #fire-status { text-align: center; font-size: 0.82rem; min-height: 20px; color: var(--green); }

  #fire-log { display: flex; flex-direction: column; gap: 6px; max-height: 200px; overflow-y: auto; }
  .log-entry { background: var(--navy); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; font-size: 0.78rem; display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
  .log-entry .log-text { color: var(--text); flex: 1; }
  .log-entry .log-meta { color: var(--muted); white-space: nowrap; text-align: right; }
  .log-type-tag { display: inline-block; border-radius: 4px; padding: 1px 6px; font-size: 0.7rem; font-family: 'Bebas Neue', sans-serif; letter-spacing: 1px; margin-right: 6px; }
  .tag-shoutout { background: #ff2d7830; color: var(--pink); }
  .tag-hype { background: #ffab0030; color: var(--amber); }
  .tag-rotation { background: #2979ff30; color: var(--blue); }
  .tag-poll { background: #d500f930; color: var(--purple); }

  .bottom-bar {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 24px; background: var(--panel); border-top: 1px solid var(--border);
    font-size: 0.8rem; color: var(--muted);
  }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
</style>
</head>
<body>

<!-- PIN -->
<div id="pin-screen">
  <div class="pin-box">
    <div class="pin-logo">üì£ Cheer<span>Pal</span></div>
    <div class="pin-gym-name" id="pin-gym-name"></div>
    <div class="pin-tagline">Controlador de Transmisi√≥n</div>
    <div class="pin-label">PIN del Director</div>
    <input type="password" id="pin-input" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric"/>
    <button id="pin-btn">ENTRAR</button>
    <div id="pin-error"></div>
  </div>
</div>

<div id="app" style="display:none; flex-direction:column; height:100vh;">

  <header>
    <div>
      <div class="logo">üì£ Cheer<span>Pal</span></div>
      <div class="header-gym" id="header-gym-name">Cargando‚Ä¶</div>
    </div>
    <div class="header-status">
      <div class="live-badge"><div class="live-dot"></div>LIVE</div>
      <div class="listener-count">Familias: <strong id="listener-count">‚Äî</strong></div>
    </div>
  </header>

  <div class="team-bar" id="team-bar">
    <span class="team-bar-label">Equipo:</span>
    <button class="team-btn all-btn active" data-team="TODOS">üì£ TODOS LOS EQUIPOS</button>
  </div>

  <div class="main" style="flex:1; overflow:hidden;">

    <!-- LEFT: Fan Mensajes -->
    <div class="panel">
      <div class="panel-title">
        üí¨ Mensajes de Familias
        <span class="badge" id="msg-count">0</span>
      </div>
      <div id="fan-feed">
        <div class="empty-feed">No messages yet.<br/>Mensajes from families appear here.</div>
      </div>
    </div>

    <!-- RIGHT: Broadcast -->
    <div class="panel">
      <div class="panel-title">üì° Controles de Transmisi√≥n</div>

      <div>
        <div class="field-label">Tipo de Alerta</div>
        <div class="type-grid">
          <button class="type-btn active" data-type="Reconocimiento"><span class="type-icon">üì£</span><span class="type-label">Reconocimiento</span></button>
          <button class="type-btn" data-type="Hype"><span class="type-icon">üî•</span><span class="type-label">Hype</span></button>
          <button class="type-btn" data-type="Rotaci√≥n"><span class="type-icon">üìã</span><span class="type-label">Rotaci√≥n</span></button>
          <button class="type-btn" data-type="Encuesta"><span class="type-icon">üó≥Ô∏è</span><span class="type-label">Encuesta</span></button>
        </div>
      </div>

      <div>
        <div class="field-label">Mensaje</div>
        <textarea class="broadcast-input" id="broadcast-msg" placeholder="Escribe tu mensaje para las familias‚Ä¶" rows="3"></textarea>
      </div>

      <div class="ticker-row">
        <div class="field-label" style="margin:0;">Ticker</div>
        <button class="ticker-toggle" id="ticker-toggle"><span class="ticker-dot"></span> OFF</button>
        <div class="field-label" style="margin:0;">Sonido</div>
        <button class="ticker-toggle" id="sound-toggle"><span class="ticker-dot"></span> OFF</button>
      </div>

      <div>
        <div class="field-label">Quick Mensajes</div>
        <div class="quick-grid" id="quick-grid">
          <button class="quick-btn" data-msg="üìç Todas las familias se re√∫nen en la entrada principal despu√©s de premiaci√≥n.">Reunirse en Entrada</button>
          <button class="quick-btn" data-msg="üèÜ ¬°Los puntajes est√°n publicados ‚Äî revisa el marcador!">Puntajes Publicados</button>
          <button class="quick-btn" data-msg="üì∏ ¬°Las fotos est√°n disponibles! Revisa la galer√≠a en la app.">Fotos Disponibles</button>
          <button class="quick-btn" data-msg="üéâ ¬°Excelente trabajo ‚Äî estamos muy orgullosos de cada atleta!">Excelente Trabajo</button>
          <button class="quick-btn" data-msg="‚ö†Ô∏è Cambio de horario ‚Äî consulta con el director de tu equipo.">Cambio de Horario</button>
        </div>
      </div>

      <button id="fire-btn">üöÄ ENVIAR ALERTA</button>
      <div id="fire-status"></div>

      <div>
        <div class="panel-title" style="font-size:1rem;">üìã Registro de Alertas</div>
        <div id="fire-log"><div style="color:var(--muted);font-size:0.8rem;text-align:center;padding:10px;">Nada enviado a√∫n.</div></div>
      </div>
    </div>
  </div>

  <div class="bottom-bar">
    <div id="session-time">Sesi√≥n: 00:00</div>
    <button id="end-session-btn" onclick="endSession()">‚èπ FIN DE SESI√ìN</button>
    <div>Gimnasio: <strong id="footer-gym-name" style="color:var(--text);">‚Äî</strong></div>
  </div>
</div>

<script>
  const SUPABASE_URL = 'https://pexmoqldjbtpjxjtfsxs.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBleG1vcWxkamJ0cGp4anRmc3hzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3OTg3MDksImV4cCI6MjA4NzM3NDcwOX0.wZNaFCVuApL2ftozAxI52UBmmH6heeVV7co-0OptonA';
  const CORRECT_PIN  = '2025';
  const POLL_INTERVAL = 8000;

  let gymData      = null;
  let gymSlug      = null;
  let selectedTeam = 'TODOS';
  let selectedType = 'Reconocimiento';
  let tickerOn     = false;
  let soundOn      = false;
  let sessionStart = Date.now();
  let shoutedIds   = new Set();
  let teams        = [];

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // BOOT
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function boot() {
    const params = new URLSearchParams(window.location.search);
    gymSlug = params.get('gym');
    if (!gymSlug) { document.getElementById('pin-error').textContent = 'No se especific√≥ gimnasio en la URL.'; return; }

    try {
      const res = await supaFetch('GET', `/rest/v1/gyms?slug=eq.${gymSlug}&limit=1`);
      const data = await res.json();
      if (!data.length) { document.getElementById('pin-error').textContent = 'Gimnasio no encontrado.'; return; }
      gymData = data[0];
      document.getElementById('pin-gym-name').textContent = gymData.name;
    } catch(e) {
      document.getElementById('pin-error').textContent = 'No se pudo cargar el gimnasio.';
    }
  }

  // ‚îÄ‚îÄ PIN ‚îÄ‚îÄ
  function attemptPin() {
    if (document.getElementById('pin-input').value === CORRECT_PIN) {
      document.getElementById('pin-screen').style.display = 'none';
      document.getElementById('app').style.display = 'flex';
      document.getElementById('header-gym-name').textContent = gymData.name;
      document.getElementById('footer-gym-name').textContent = gymData.name;
      document.title = `${gymData.name} ‚Äî Controlador`;
      loadTeams();
      startEncuestaing();
      startSessionTimer();
    } else {
      document.getElementById('pin-error').textContent = 'PIN incorrecto.';
      document.getElementById('pin-input').value = '';
    }
  }
  document.getElementById('pin-btn').addEventListener('click', attemptPin);
  document.getElementById('pin-input').addEventListener('keydown', e => { if (e.key === 'Enter') attemptPin(); });

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // TEAMS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function loadTeams() {
    const res = await supaFetch('GET', `/rest/v1/gym_teams?gym_id=eq.${gymData.gym_id}&order=order_num.asc`);
    teams = await res.json();

    const bar = document.getElementById('team-bar');
    // Keep ALL button, add team buttons
    bar.innerHTML = `<span class="team-bar-label">Equipo:</span>
      <button class="team-btn all-btn active" data-team="TODOS" onclick="selectTeam(this, 'TODOS')">üì£ TODOS LOS EQUIPOS</button>` +
      teams.map(t =>
        `<button class="team-btn" data-team="${escHtml(t.name)}" onclick="selectTeam(this, '${escHtml(t.name)}')">${t.emoji || '‚≠ê'} ${escHtml(t.name)}</button>`
      ).join('');

    // Quick messages per team
    const qg = document.getElementById('quick-grid');
    const deckBtns = teams.map(t =>
      `<button class="quick-btn" data-msg="‚è∞ ${escHtml(t.name)} Team ‚Äî est√°n en turno. ¬°Dir√≠janse al piso ahora.">${escHtml(t.name)} En Turno</button>`
    ).join('');
    qg.innerHTML = deckBtns +
      `<button class="quick-btn" data-msg="üèÜ ¬°Los puntajes est√°n publicados ‚Äî revisa el marcador!">Puntajes Publicados</button>
       <button class="quick-btn" data-msg="üìç Todas las familias se re√∫nen en la entrada principal despu√©s de premiaci√≥n.">Reunirse en Entrada</button>
       <button class="quick-btn" data-msg="üì∏ ¬°Las fotos est√°n disponibles!">Fotos Disponibles</button>
       <button class="quick-btn" data-msg="üéâ ¬°Excelente trabajo ‚Äî tan orgullosos de cada atleta!">Excelente Trabajo</button>
       <button class="quick-btn" data-msg="‚ö†Ô∏è Cambio de horario ‚Äî consulta con el director de tu equipo.">Cambio de Horario</button>`;

    document.querySelectorAll('.quick-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.getElementById('broadcast-msg').value = btn.dataset.msg;
      });
    });
  }

  function selectTeam(btn, team) {
    document.querySelectorAll('.team-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedTeam = team;
  }

  // ‚îÄ‚îÄ TYPE BUTTONS ‚îÄ‚îÄ
  document.querySelectorAll('.type-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      selectedType = btn.dataset.type;
    });
  });

  // ‚îÄ‚îÄ TOGGLES ‚îÄ‚îÄ
  document.getElementById('ticker-toggle').addEventListener('click', function() {
    tickerOn = !tickerOn;
    this.classList.toggle('on', tickerOn);
    this.innerHTML = `<span class="ticker-dot"></span> ${tickerOn ? 'ON' : 'OFF'}`;
  });
  document.getElementById('sound-toggle').addEventListener('click', function() {
    soundOn = !soundOn;
    this.classList.toggle('sound-on', soundOn);
    this.innerHTML = `<span class="ticker-dot"></span> ${soundOn ? 'ON' : 'OFF'}`;
  });

  // ‚îÄ‚îÄ FIRE ‚îÄ‚îÄ
  document.getElementById('fire-btn').addEventListener('click', async () => {
    const msg = document.getElementById('broadcast-msg').value.trim();
    const btn = document.getElementById('fire-btn');
    const status = document.getElementById('fire-status');
    if (!msg) { status.textContent = '‚ö†Ô∏è Ingresa un mensaje primero.'; status.style.color = 'var(--amber)'; return; }

    btn.disabled = true;
    status.textContent = 'Enviando‚Ä¶'; status.style.color = 'var(--muted)';

    const payload = {
      gym_id: gymData.gym_id,
      team: selectedTeam,
      type: selectedType,
      message: msg,
      ticker: tickerOn,
      sound: soundOn,
      fired_at: new Date().toISOString(),
      status: 'active'
    };

    try {
      const res = await supaFetch('POST', '/rest/v1/broadcast_queue', payload);
      if (!res.ok) throw new Error();
      status.textContent = `‚úÖ Enviado a ${selectedTeam === 'TODOS' ? 'todos los equipos' : selectedTeam + ' equipo'}!`;
      status.style.color = 'var(--green)';
      addToLog(payload);
      document.getElementById('broadcast-msg').value = '';
      setTimeout(() => { status.textContent = ''; }, 4000);
    } catch(e) {
      status.textContent = '‚ùå No se pudo enviar. Verifica tu conexi√≥n.';
      status.style.color = 'var(--pink)';
    }
    btn.disabled = false;
  });

  function addToLog(entry) {
    const log = document.getElementById('fire-log');
    const tagClass = 'tag-' + (entry.type || 'shoutout').toLowerCase();
    const time = new Date(entry.fired_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    const html = `<div class="log-entry">
      <div class="log-text"><span class="log-type-tag ${tagClass}">${entry.type}</span>${escHtml(entry.message)}</div>
      <div class="log-meta">${escHtml(entry.team)}<br/>${time}${entry.ticker?'<br/>üéûÔ∏è':''}</div>
    </div>`;
    if (log.querySelector('div[style]')) log.innerHTML = '';
    log.insertAdjacentHTML('afterbegin', html);
  }

  // ‚îÄ‚îÄ POLL FAN MESSAGES ‚îÄ‚îÄ
  async function pollFanMensajes() {
    if (!gymData) return;
    try {
      const res = await supaFetch('GET',
        `/rest/v1/fan_messages?gym_id=eq.${gymData.gym_id}&status=eq.pending&order=created_at.desc&limit=30`
      );
      if (!res.ok) return;
      const msgs = await res.json();
      renderFanMensajes(msgs);
      document.getElementById('msg-count').textContent = msgs.length;

      // Family count from members
      const mRes = await supaFetch('GET', `/rest/v1/gym_members?gym_id=eq.${gymData.gym_id}&joined_at=not.is.null&select=id`);
      const members = await mRes.json();
      document.getElementById('listener-count').textContent = members.length;
    } catch(e) {}
  }

  function renderFanMensajes(msgs) {
    const feed = document.getElementById('fan-feed');
    if (!msgs.length) {
      feed.innerHTML = '<div class="empty-feed">No messages yet.<br/>Mensajes from families appear here.</div>';
      return;
    }
    feed.innerHTML = msgs.map(m => {
      const shouted = shoutedIds.has(m.id);
      const time = new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      return `<div class="fan-msg-card">
        <div class="fan-msg-meta">
          <div>
            <span class="fan-msg-name">${escHtml(m.name||'Anonymous')}</span>
            ${m.team ? `<span class="fan-msg-team">${escHtml(m.team)}</span>` : ''}
          </div>
          <span class="fan-msg-time">${time}</span>
        </div>
        <div class="fan-msg-text">${escHtml(m.message)}</div>
        <div class="fan-msg-actions">
          <button class="shoutout-btn ${shouted?'done':''}" onclick="shoutout(${m.id},'${escHtml(m.name||'Fan')}','${escHtml(m.message)}',this)" ${shouted?'disabled':''}>
            ${shouted ? '‚úÖ Reconocido' : 'üì£ Reconocimiento'}
          </button>
          <button class="dismiss-btn" onclick="dismissMsg(${m.id},this)">Ignorar</button>
        </div>
      </div>`;
    }).join('');
  }

  function shoutout(id, name, message, btn) {
    shoutedIds.add(id);
    btn.classList.add('done');
    btn.textContent = '‚úÖ Reconocido';
    btn.disabled = true;
    document.getElementById('broadcast-msg').value = `üì£ Reconocimiento to ${name}: "${message}"`;
    document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('.type-btn[data-type="Reconocimiento"]').classList.add('active');
    selectedType = 'Reconocimiento';
  }

  async function endSession() {
    if (!gymData) return;
    if (!confirm('¬øFinalizar sesi√≥n? Esto limpiar√° todas las alertas activas en las pantallas de las familias.')) return;
    const btn = document.getElementById('end-session-btn');
    btn.disabled = true;
    btn.textContent = 'Finalizando‚Ä¶';
    try {
      await supaFetch('PATCH',
        `/rest/v1/broadcast_queue?gym_id=eq.${gymData.gym_id}&status=eq.active`,
        { status: 'expired' }
      );
      btn.textContent = '‚úì Sesi√≥n Finalizada';
      btn.style.color = 'var(--green)';
      btn.style.borderColor = 'var(--green)';
      document.getElementById('fire-status').style.color = 'var(--green)';
      document.getElementById('fire-status').textContent = 'Sesi√≥n finalizada ‚Äî todas las alertas eliminadas de las pantallas.';
      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = '‚èπ FIN DE SESI√ìN';
        btn.style.color = '';
        btn.style.borderColor = '';
        document.getElementById('fire-status').textContent = '';
      }, 5000);
    } catch(e) {
      btn.disabled = false;
      btn.textContent = '‚èπ FIN DE SESI√ìN';
      document.getElementById('fire-status').style.color = '#ff4444';
      document.getElementById('fire-status').textContent = '‚ùå No se pudo finalizar la sesi√≥n. Int√©ntalo de nuevo.';
    }
  }

    async function dismissMsg(id, btn) {
    try {
      await supaFetch('PATCH', `/rest/v1/fan_messages?id=eq.${id}`, { status: 'dismissed' });
      btn.closest('.fan-msg-card').remove();
    } catch(e) {}
  }

  // ‚îÄ‚îÄ SESSION TIMER ‚îÄ‚îÄ
  function startSessionTimer() {
    setInterval(() => {
      const elapsed = Math.floor((Date.now() - sessionStart) / 1000);
      const m = String(Math.floor(elapsed/60)).padStart(2,'0');
      const s = String(elapsed%60).padStart(2,'0');
      document.getElementById('session-time').textContent = `Sesi√≥n: ${m}:${s}`;
    }, 1000);
  }

  function startEncuestaing() {
    pollFanMensajes();
    setInterval(pollFanMensajes, POLL_INTERVAL);
  }

  async function supaFetch(method, path, body = null) {
    const headers = {
      'apikey': SUPABASE_KEY, 'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json', 'Prefer': 'return=representation'
    };
    const opts = { method, headers };
    if (body) opts.body = JSON.stringify(body);
    return fetch(`${SUPABASE_URL}${path}`, opts);
  }

  function escHtml(str) {
    return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  boot();
</script>
</body>
</html>
