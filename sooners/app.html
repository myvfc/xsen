<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Boomer ‚Äî XSEN Sooners Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f0f0f0;
      color: #222;
    }

    a { text-decoration: none; }

    /* =========================
       CHAT CONTAINER
    ========================= */
    .chat-container {
      width: 100%;
      max-width: 480px;
      margin: 16px auto;
      border: 1px solid #111;
      border-radius: 10px;
      background: #fff;
      display: flex;
      flex-direction: column;
      min-height: calc(100vh - 32px);
    }

    /* =========================
       HEADER
    ========================= */
    .chat-header {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #841617;
      color: #FDF9D8;
      padding: 12px 14px;
      font-weight: 600;
      border-radius: 10px 10px 0 0;
    }

    .header-logo-link {
      display: flex;
      align-items: center;
    }

    .header-logo {
      height: 32px;
      max-width: 120px;
      width: auto;
      object-fit: contain;
      cursor: pointer;
    }

    .header-title {
      font-size: 16px;
      font-weight: 700;
      white-space: nowrap;
      color: #FDF9D8;
    }

    /* =========================
       MANAGE ACCOUNT BUTTON
    ========================= */
    #manageSubBtn {
      margin-left: auto;
      background: none;
      border: 1px solid rgba(253,249,216,0.5);
      color: #FDF9D8;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      cursor: pointer;
      margin-right: 10px;
      white-space: nowrap;
    }

    #manageSubBtn:hover {
      background: rgba(253,249,216,0.15);
    }

    /* =========================
       LIVE / OFFLINE BADGE
    ========================= */
    .live-badge {
      font-size: 12px;
      font-weight: 800;
      padding: 5px 10px;
      border-radius: 999px;
      white-space: nowrap;
      border: 1px solid rgba(255,255,255,0.4);
      transition: all 0.25s ease;
    }

    .live-badge.live {
      background: #ff2d2d;
      color: #fff;
      box-shadow: 0 0 8px rgba(255,45,45,0.8);
    }

    .live-badge.offline {
      background: #666;
      color: #eee;
    }

    /* =========================
       LIVE CTA (LISTEN + DONATE)
    ========================= */
    .live-cta {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin: 12px;
    }

    .live-cta button {
      flex: 1;
      padding: 10px 14px;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: opacity 0.2s;
    }

    .live-cta button:hover { opacity: 0.85; }

    #listenLiveBtn {
      background: #841617;
      color: #FDF9D8;
    }

    #donateBtn {
      background: #ffd54f;
      color: #111;
    }

    /* =========================
       LIVE AUDIO CARD
    ========================= */
    #xsen-audio-card {
      margin: 0 12px 12px;
      background: #1a1a1a;
      border-radius: 10px;
      padding: 12px;
    }

    .xsen-audio-header {
      color: #ff2d2d;
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 8px;
    }

    #xsenAudio {
      width: 100%;
      height: 36px;
    }

    .xsen-audio-status {
      color: #aaa;
      font-size: 12px;
      margin-top: 6px;
      text-align: center;
    }

    /* =========================
       FAN ‚Üí BROADCASTER PANEL
    ========================= */
    .fan-message-panel {
      margin: 0 12px 12px;
      padding: 16px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .fan-message-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      font-weight: 800;
      font-size: 15px;
      color: #841617;
      margin-bottom: 14px;
      padding-bottom: 8px;
      border-bottom: 2px solid #f0e0e0;
    }

    .fan-message-panel input,
    .fan-message-panel textarea {
      width: 100%;
      margin: 8px 0;
      padding: 9px 11px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-family: inherit;
    }

    .fan-message-panel input:focus,
    .fan-message-panel textarea:focus {
      outline: none;
      border-color: #841617;
    }

    #sendFanMessage {
      width: 100%;
      margin-top: 10px;
      padding: 11px;
      background: #841617;
      color: #FDF9D8;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    #sendFanMessage:hover { opacity: 0.9; }

    .fan-message-status {
      text-align: center;
      font-size: 13px;
      margin-top: 8px;
      min-height: 16px;
      color: #666;
    }

    /* =========================
       CHAT MESSAGES
    ========================= */
    .chat-messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      background: #fdfdfd;
      min-height: 300px;
    }

    .message {
      margin-bottom: 12px;
      padding: 10px 14px;
      border-radius: 10px;
      max-width: 85%;
      line-height: 1.5;
      font-size: 14px;
    }

    .message.bot {
      background: #f0f0f0;
      color: #222;
    }

    .message.user {
      background: #841617;
      color: #FDF9D8;
      margin-left: auto;
    }

    .message.video {
      padding: 6px;
      background: transparent;
      max-width: 100%;
    }

    .message.video iframe {
      max-width: 100%;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    }

    /* =========================
       CHAT INPUT
    ========================= */
    .chat-input {
      display: flex;
      border-top: 1px solid #ddd;
      background: #fff;
      border-radius: 0 0 10px 10px;
    }

    .chat-input input {
      flex: 1;
      padding: 14px;
      border: none;
      font-size: 1rem;
      font-family: inherit;
      background: transparent;
    }

    .chat-input input:focus { outline: none; }

    .chat-input button {
      background: #841617;
      color: #FDF9D8;
      border: none;
      padding: 0 20px;
      font-size: 1.2rem;
      cursor: pointer;
      border-radius: 0 0 10px 0;
      transition: opacity 0.2s;
    }

    .chat-input button:hover { opacity: 0.9; }

    /* =========================
       NAV BAR
    ========================= */
    .nav-bar {
      display: flex;
      justify-content: space-around;
      padding: 10px;
      border-top: 1px solid #eee;
      background: #fafafa;
      border-radius: 0 0 10px 10px;
    }

    .nav-bar a {
      font-size: 12px;
      color: #841617;
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .nav-bar a:hover { opacity: 1; }

    /* =========================
       MOBILE
    ========================= */
    @media (max-width: 520px) {
      .chat-container {
        margin: 0;
        border-radius: 0;
        border: none;
        min-height: 100vh;
      }
      .chat-header { border-radius: 0; }
      .chat-input button { border-radius: 0; }
      .nav-bar { border-radius: 0; }
    }
  </style>
</head>
<body>

  <div class="chat-container">

    <!-- HEADER -->
    <header class="chat-header">
      <a href="https://sooners.xsen.fun" class="header-logo-link" target="_blank" rel="noopener">
        <img
          src="https://raw.githubusercontent.com/myvfc/xsen-images/main/Boomer%20Bot%20logo.png"
          alt="XSEN Sooners"
          class="header-logo"
        />
      </a>
      <span class="header-title">üèà Boomer</span>

      <!-- MANAGE ACCOUNT -->
      <button id="manageSubBtn" type="button">‚öôÔ∏è Account</button>

      <!-- LIVE/OFFLINE BADGE -->
      <span id="liveBadge" class="live-badge offline">‚ö™ OFFLINE</span>
    </header>

    <!-- LISTEN LIVE + DONATE -->
    <div class="live-cta">
      <button id="listenLiveBtn" type="button">üî¥ Listen Live</button>
      <button id="donateBtn" type="button">‚ù§Ô∏è Donate</button>
    </div>

    <!-- LIVE AUDIO CARD -->
    <div id="xsen-audio-card" style="display:none;">
      <div class="xsen-audio-header">üî¥ LIVE FAN CAST</div>
      <audio id="xsenAudio" preload="none" playsinline controls>
        <source src="" type="audio/mpeg" />
        Your browser does not support audio.
      </audio>
      <div id="audioStatus" class="xsen-audio-status">Tap ‚ñ∂ to listen live</div>
    </div>

    <!-- FAN ‚Üí BROADCASTER -->
    <div class="fan-message-panel">
      <div class="fan-message-header">üì£ Message the Broadcaster</div>
      <input type="text" id="fanName" placeholder="Your name (optional)" />
      <textarea id="fanMessage" rows="3" placeholder="Send a message to the broadcaster‚Ä¶"></textarea>
      <button id="sendFanMessage" type="button">Send Message</button>
      <div id="fanMessageStatus" class="fan-message-status"></div>
    </div>

    <!-- CHAT MESSAGES -->
    <div id="messages" class="chat-messages">
      <div class="message bot">
        üëã Boomer Sooner! Ask me anything about OU sports ‚Äî history, stats, highlights, schedules, or players.
      </div>
    </div>

    <!-- CHAT INPUT -->
    <form id="chatForm" class="chat-input">
      <input
        type="text"
        id="userInput"
        placeholder="Ask Boomer‚Ä¶"
        autocomplete="off"
        required
      />
      <button type="submit">‚û§</button>
    </form>

    <!-- NAV BAR -->
    <div class="nav-bar">
      <a href="https://sooners.xsen.fun">‚Üê Channel Home</a>
      <a href="https://xsen.fun">XSEN Network</a>
      <a href="https://sooners.xsen.fun">Subscribe</a>
    </div>

  </div>


  <script>
    // ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const ORCHESTRATOR_URL  = 'https://energetic-joy-production.up.railway.app';
    const CHAT_API_URL      = 'https://energetic-joy-production.up.railway.app/chat';
    const FAN_MESSAGE_API   = 'https://xsen-fan-messages-production.up.railway.app/fan-message';
    const LIVE_STATUS_URL   = 'https://xsen-fan-messages-production.up.railway.app/live-status';
    const LIVE_AUDIO_STREAM = 'https://a12.asurahosting.com/listen/xsen_radio/radio.mp3';
    const DONATE_URL        = 'https://thebotosphere.com';
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    document.addEventListener('DOMContentLoaded', () => {

      const form          = document.getElementById('chatForm');
      const input         = document.getElementById('userInput');
      const messages      = document.getElementById('messages');
      const liveBadge     = document.getElementById('liveBadge');
      const audioCard     = document.getElementById('xsen-audio-card');
      const audioEl       = document.getElementById('xsenAudio');
      const audioStatus   = document.getElementById('audioStatus');
      const listenLiveBtn = document.getElementById('listenLiveBtn');
      const donateBtn     = document.getElementById('donateBtn');
      const fanNameInput  = document.getElementById('fanName');
      const fanMsgInput   = document.getElementById('fanMessage');
      const sendFanMsgBtn = document.getElementById('sendFanMessage');
      const fanMsgStatus  = document.getElementById('fanMessageStatus');
      const manageSubBtn  = document.getElementById('manageSubBtn');

      let firstVideoPlayed = false;

      // ‚îÄ‚îÄ‚îÄ MANAGE ACCOUNT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      manageSubBtn?.addEventListener('click', async () => {
        const token = localStorage.getItem('xsen_auth_token');
        if (!token) {
          window.location.href = 'https://sooners.xsen.fun';
          return;
        }
        try {
          const res  = await fetch(`${ORCHESTRATOR_URL}/api/create-portal-session`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });
          const data = await res.json();
          if (data.url) window.location.href = data.url;
        } catch (e) {
          alert('Could not open account management. Please try again.');
        }
      });

      // ‚îÄ‚îÄ‚îÄ CHAT FORM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = input.value.trim();
        if (!text) return;

        addMsg(text, 'user');
        input.value = '';

        const thinking = addMsg('üèà Boomer is thinking‚Ä¶', 'bot');

        try {
          const res  = await fetch(CHAT_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
        message: text,
        school: 'sooners'
    }) 
          });

          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          thinking.remove();

          if (!data?.response) {
            addMsg("Boomer Sooner! I didn't catch that ‚Äî try again.", 'bot');
            return;
          }

          renderResponse(data.response);

        } catch (err) {
          console.error('Chat error:', err);
          thinking.remove();
          addMsg("Sorry, Sooner ‚Äî couldn't reach Boomer right now.", 'bot');
        }
      });

      // ‚îÄ‚îÄ‚îÄ RENDER RESPONSE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function renderResponse(text) {
        firstVideoPlayed = false;
        text.split('\n').forEach(line => {
          const t = line.trim();
          if (!t) return;

          if (/^(play|listen|start).*(radio|audio|broadcast|fan cast)/i.test(t)) {
            addMsg('üîä Starting live fan cast‚Ä¶', 'bot');
            playAudio();
            return;
          }

          const m = t.match(/(https:\/\/player\.xsen\.fun\?v=[A-Za-z0-9_-]+)/i);
          if (m) {
            const title = t.replace(m[1], '').trim();
            if (title) addMsg(title, 'bot');
            addVideo(m[1]);
          } else {
            addMsg(t, 'bot');
          }
        });
      }

      // ‚îÄ‚îÄ‚îÄ ADD TEXT MESSAGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function addMsg(text, sender) {
        const div = document.createElement('div');
        div.className = `message ${sender}`;
        div.innerHTML = text.replace(
          /(https?:\/\/[^\s]+)/g,
          '<a href="$1" target="_blank" rel="noopener" style="color:#0066cc;text-decoration:underline;">$1</a>'
        );
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
        return div;
      }

      // ‚îÄ‚îÄ‚îÄ ADD VIDEO EMBED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function addVideo(url) {
        const wrap   = document.createElement('div');
        wrap.className = 'message bot video';

        const iframe = document.createElement('iframe');
        const src    = new URL(url);
        if (!firstVideoPlayed) {
          src.searchParams.set('autoplay', '1');
          src.searchParams.set('muted', '1');
          src.searchParams.set('playsinline', '1');
        }

        iframe.src             = src.toString();
        iframe.width           = '150%';
        iframe.height          = '300';
        iframe.allow           = 'autoplay; encrypted-media; picture-in-picture';
        iframe.allowFullscreen = true;
        iframe.loading         = 'lazy';
        iframe.style.cssText   = 'border:none; border-radius:10px;';

        wrap.appendChild(iframe);
        messages.appendChild(wrap);
        messages.scrollTop = messages.scrollHeight;
        firstVideoPlayed = true;
      }

      // ‚îÄ‚îÄ‚îÄ LIVE AUDIO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      function playAudio() {
        if (!audioEl || !audioCard) return;
        audioCard.style.display = 'block';
        audioEl.src = `${LIVE_AUDIO_STREAM}?ts=${Date.now()}`;
        audioEl.play()
          .then(() => { if (audioStatus) audioStatus.textContent = 'üîä Live fan cast playing'; })
          .catch(() => { if (audioStatus) audioStatus.textContent = 'Tap ‚ñ∂ to start audio'; });
      }

      listenLiveBtn?.addEventListener('click', () => {
        addMsg('üî¥ Connecting you to the live fan cast‚Ä¶', 'bot');
        playAudio();
      });

      // ‚îÄ‚îÄ‚îÄ DONATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      donateBtn?.addEventListener('click', () => {
        addMsg('‚ù§Ô∏è Supporting NIL helps keep the fan cast alive. Thank you!', 'bot');
        window.open(DONATE_URL, '_blank', 'noopener');
      });

      // ‚îÄ‚îÄ‚îÄ FAN ‚Üí BROADCASTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      sendFanMsgBtn?.addEventListener('click', async (e) => {
        e.preventDefault();
        const name    = fanNameInput?.value.trim();
        const message = fanMsgInput?.value.trim();

        if (!message) {
          fanMsgStatus.textContent = 'Please enter a message.';
          return;
        }

        fanMsgStatus.textContent = 'Sending‚Ä¶';

        try {
          const res = await fetch(FAN_MESSAGE_API, {
            method: 'POST',
            body: new URLSearchParams({
              name: name || 'Anonymous Fan',
              message,
              source: 'Boomer Live'
            })
          });

          if (!res.ok) throw new Error('Send failed');
          fanMsgStatus.textContent = '‚úÖ Message sent to the broadcaster!';
          fanMsgInput.value = '';

        } catch (err) {
          console.error('Fan message error:', err);
          fanMsgStatus.textContent = '‚ùå Could not send message.';
        }
      });

      // ‚îÄ‚îÄ‚îÄ LIVE STATUS POLLING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      async function updateLiveStatus() {
        if (!liveBadge) return;
        try {
          const res  = await fetch(LIVE_STATUS_URL, { cache: 'no-store' });
          const data = await res.json();
          if (data.isLive) {
            liveBadge.textContent = 'üî¥ LIVE';
            liveBadge.className   = 'live-badge live';
          } else {
            liveBadge.textContent = '‚ö™ OFFLINE';
            liveBadge.className   = 'live-badge offline';
          }
        } catch (e) {
          console.warn('Live status check failed:', e);
        }
      }

      updateLiveStatus();
      setInterval(updateLiveStatus, 20000);

    });
  </script>

</body>
</html>
